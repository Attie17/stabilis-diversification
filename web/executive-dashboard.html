<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Executive Dashboard - Stabilis</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/executive-dashboard.css">
    <link rel="stylesheet" href="css/ai-chat-component.css">
</head>

<body>
    <div class="executive-container">
        <!-- Header -->
        <header class="executive-header">
            <div class="header-left">
                <h1>üìä Executive Command Center</h1>
                <div class="last-updated" id="last-updated">Loading...</div>
            </div>
            <div class="header-right">
                <a href="landing.html?stay=1" class="view-project-btn" title="Return to Landing">üè† Project Hub</a>
                <button class="reports-menu-trigger" onclick="openReportsMenu()"
                    title="Reports &amp; Analytics quick menu">üìë Reports &amp; Analytics</button>
                <button onclick="openExcelFile()" class="excel-edit-btn" title="Edit project data in Excel">üìä Edit Workbook</button>
                <button onclick="showEditMilestoneModal()" class="edit-milestone-btn"
                    title="Edit any project milestone">‚úèÔ∏è Edit Milestone</button>
                <button onclick="refreshDashboard()" class="refresh-btn" title="Refresh Data">üîÑ</button>
                <div class="user-info" id="user-info"></div>
            </div>
        </header>

        <!-- Critical Alerts Banner -->
        <div class="alerts-banner" id="alerts-banner" style="display: none;"></div>

        <!-- Top Stats Grid -->
        <section class="top-stats">
            <div class="stat-card turnaround-card">
                <div class="stat-icon">üö®</div>
                <div class="stat-content">
                    <h3>Turnaround</h3>
                    <div class="stat-number" id="turnaround-progress">0%</div>
                    <div class="stat-meta" id="turnaround-meta">Loading...</div>
                </div>
            </div>
            <div class="stat-card diversification-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-content">
                    <h3>Diversification</h3>
                    <div class="stat-number" id="diversification-progress">0%</div>
                    <div class="stat-meta" id="diversification-meta">Loading...</div>
                </div>
            </div>
            <div class="stat-card wellness-card">
                <div class="stat-icon">üíö</div>
                <div class="stat-content">
                    <h3>Wellness Centre</h3>
                    <div class="stat-number" id="wellness-progress">0%</div>
                    <div class="stat-meta" id="wellness-meta">Loading...</div>
                </div>
            </div>
            <div class="stat-card overall-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <h3>Overall Progress</h3>
                    <div class="stat-number" id="overall-progress">0%</div>
                    <div class="stat-meta" id="overall-meta">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Quick Navigation -->
        <nav class="quick-nav">
            <button class="nav-btn active" onclick="showSection('overview')">üìä Overview</button>
            <button class="nav-btn" onclick="showSection('financial')">üí∞ Financial</button>
            <button class="nav-btn" onclick="showSection('risks')">‚ö†Ô∏è Risks</button>
            <button class="nav-btn" onclick="showSection('timeline')">üìÖ Timeline</button>
            <button class="nav-btn" onclick="showSection('team')">üë• Team</button>
            <button class="nav-btn" onclick="showSection('projects')">üéØ Projects</button>
            <button class="nav-btn" onclick="showSection('reports')">üìë Reports</button>
        </nav>

        <!-- Content Sections -->
        <main class="dashboard-content">
            <!-- Overview Section -->
            <section id="section-overview" class="content-section active">
                <div class="section-grid">
                    <!-- Critical Items -->
                    <div class="dashboard-card full-width">
                        <h2>üö® Requires Immediate Attention</h2>
                        <div id="critical-items" class="critical-list">Loading...</div>
                    </div>

                    <!-- Revenue Summary -->
                    <div class="dashboard-card">
                        <h2>üí∞ Revenue Summary (18 Months)</h2>
                        <div id="revenue-summary" class="financial-summary">Loading...</div>
                    </div>

                    <!-- Risk Overview -->
                    <div class="dashboard-card">
                        <h2>‚ö†Ô∏è Risk Overview</h2>
                        <div id="risk-overview" class="risk-summary">Loading...</div>
                    </div>

                    <!-- This Week -->
                    <div class="dashboard-card">
                        <h2>üìÖ This Week's Milestones</h2>
                        <div id="this-week" class="milestone-list">Loading...</div>
                    </div>

                    <!-- Team Capacity -->
                    <div class="dashboard-card">
                        <h2>üë• Team Capacity</h2>
                        <div id="team-capacity" class="team-summary">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Financial Section -->
            <section id="section-financial" class="content-section">
                <div class="section-grid">
                    <div class="dashboard-card full-width">
                        <h2>üí∞ Consolidated Financial Overview</h2>
                        <div id="financial-overview">Loading...</div>
                    </div>
                    <div class="dashboard-card">
                        <h2>üìä Revenue by Project</h2>
                        <div id="revenue-breakdown">Loading...</div>
                    </div>
                    <div class="dashboard-card">
                        <h2>üí≥ Budget vs Actual</h2>
                        <div id="budget-actual">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Risks Section -->
            <section id="section-risks" class="content-section">
                <div class="section-grid">
                    <div class="dashboard-card full-width">
                        <h2>‚ö†Ô∏è All Risks Across Projects</h2>
                        <div id="all-risks">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Timeline Section -->
            <section id="section-timeline" class="content-section">
                <div class="section-grid">
                    <div class="dashboard-card full-width">
                        <h2>üìÖ Master Timeline - All Projects</h2>
                        <div id="master-timeline">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Team Section -->
            <section id="section-team" class="content-section">
                <div class="section-grid">
                    <div class="dashboard-card full-width">
                        <h2>üë• Team Allocation Across Projects</h2>
                        <div id="team-allocation">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Projects Section -->
            <section id="section-projects" class="content-section">
                <div class="section-grid">
                    <div class="dashboard-card">
                        <h2>üö® Turnaround Project</h2>
                        <button onclick="window.location.href='turnaround.html'" class="view-project-btn">View Full
                            Project</button>
                        <div id="turnaround-detail">Loading...</div>
                    </div>
                    <div class="dashboard-card">
                        <h2>üìà Diversification Project</h2>
                        <button onclick="window.location.href='index.html'" class="view-project-btn">View Full
                            Project</button>
                        <div id="diversification-detail">Loading...</div>
                    </div>
                    <div class="dashboard-card">
                        <h2>üíö Wellness Centre Project</h2>
                        <button onclick="window.location.href='wellness.html'" class="view-project-btn">View Full
                            Project</button>
                        <div id="wellness-detail">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="content-section">
                <div class="dashboard-card full-width">
                    <div class="reports-header">
                        <div>
                            <h2>üìë Reports & Analytics</h2>
                            <p class="reports-description">Steering-only command center for deep-dive report pack.</p>
                        </div>
                        <div class="reports-header-actions">
                            <button class="report-menu-btn" onclick="showReportsGuide()">üìò How to export</button>
                        </div>
                    </div>
                    <div class="reports-grid" id="reports-grid"></div>
                </div>
            </section>
        </main>
    </div>

    <div id="reports-menu-overlay" class="reports-menu-overlay" aria-hidden="true">
        <div class="reports-menu-panel" role="dialog" aria-modal="true" aria-labelledby="reports-menu-title">
            <div class="reports-menu-header">
                <div>
                    <h2 id="reports-menu-title">üìë Reports &amp; Analytics</h2>
                    <p>Quick-launch the steering pack without leaving Executive Command.</p>
                </div>
                <div class="reports-menu-actions">
                    <button class="report-menu-btn" onclick="showReportsGuide()">üìò Export instructions</button>
                    <button class="reports-menu-close" onclick="closeReportsMenu()"
                        aria-label="Close Reports Menu">‚úï</button>
                </div>
            </div>
            <div class="reports-menu-grid reports-grid" id="reports-menu-list"></div>
        </div>
    </div>

    <!-- AI Chat Widget Container -->
    <div id="ai-chat-container"></div>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/turnaround-data.js"></script>
    <script src="js/wellness-data.js"></script>
    <script src="js/edit-milestone.js"></script>
    <script src="js/ai-chat-component.js"></script>
    <script src="js/executive-dashboard.js"></script>
    <script>
        // Open Excel file for editing - now using OneDrive
        async function openExcelFile() {
            // Check authorization (CEO and FM only - not board members with view-only access)
            const currentUser = JSON.parse(localStorage.getItem('stabilis-user') || '{}');
            const authorizedUsers = ['Attie Nel', 'Nastasha Jacobs', 'Developer'];
            const boardMembers = window.BOARD_MEMBERS || ['Ds. Danie van Rensburg', 'Ds. Wynand van Niekerk'];
            
            if (!authorizedUsers.includes(currentUser.name)) {
                if (boardMembers.includes(currentUser.name)) {
                    alert('View-Only Access: Board members can view the Executive Command dashboard but cannot edit the workbook. Contact the CEO or Finance Manager for edits.');
                } else {
                    alert('Access Denied: Only the CEO (Attie Nel) and Financial Manager (Nastasha Jacobs) can edit the workbook.');
                }
                return;
            }
            
            // Open OneDrive Excel file in new tab
            const oneDriveUrl = 'https://1drv.ms/x/c/1fb6106c0dfb653b/IQAwiTAPo1EPRalRZsBRuE6iAVKUgGCC1a1qi5Xaw7KrPEg?e=wvqemv';
            window.open(oneDriveUrl, '_blank');
            
            // Show simple instructions
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:8px;max-width:500px;text-align:center;">
                    <h3 style="margin-top:0;color:#2c5282;">Excel Workbook Opened</h3>
                    <p style="color:#4a5568;line-height:1.6;">
                        The Excel workbook has been opened in OneDrive.<br><br>
                        <strong>Simply edit and save</strong> - changes sync automatically!<br><br>
                        <em style="color:#718096;font-size:0.9em;">
                            No download or upload needed. Edit from any device with OneDrive access.
                        </em>
                    </p>
                    <button onclick="this.closest('div[style*=fixed]').remove()" 
                            style="background:#3182ce;color:white;border:none;padding:10px 30px;border-radius:5px;cursor:pointer;font-size:16px;margin-top:10px;">
                        Got it
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            return;
            
            // OLD CODE BELOW (kept for reference, never reached)
            try {
                console.log('Requesting Excel file access...');
                
                // Determine backend URL based on environment
                const backendUrl = window.location.hostname.includes('localhost') 
                    ? 'http://localhost:3000'
                    : 'https://stabilis-diversification.onrender.com'; // Your Render backend URL
                
                // Call server endpoint
                const response = await fetch(`${backendUrl}/api/open-excel`, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (result.success) {
                    // Check if running on cloud deployment
                    if (result.cloudDeployment) {
                        showCloudExcelInstructions(backendUrl);
                    } else {
                        // Local deployment - Excel opened directly
                        showExcelInstructions();
                    }
                } else {
                    console.error('Server returned failure:', result);
                    alert(`Unable to access Excel file: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error accessing Excel:', error);
                alert(`Unable to access Excel file: ${error.message}\n\nPlease check your connection and try again.`);
            }
        }

        function showCloudExcelInstructions(backendUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 600px;
            `;
            modal.innerHTML = `
                <h3 style="margin-top: 0; color: #2563eb;">üìä Edit Excel Workbook</h3>
                <p style="line-height: 1.6; color: #374151;">
                    You're accessing from a web deployment. To edit the Excel file:
                </p>
                <ol style="line-height: 1.8; color: #374151;">
                    <li><strong>Download</strong> the current file</li>
                    <li><strong>Edit</strong> in Excel on your computer</li>
                    <li><strong>Upload</strong> the updated file</li>
                    <li><strong>Refresh</strong> the dashboard to see changes</li>
                </ol>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <a href="${backendUrl}/api/excel/download" 
                       download="stabilis-data.xlsx"
                       style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                        üì• Download Excel
                    </a>
                    <button onclick="showUploadDialog('${backendUrl}')" 
                            style="background: #059669; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
                        üì§ Upload Excel
                    </button>
                </div>
                <button onclick="this.parentElement.remove()" 
                        style="margin-top: 15px; background: #6b7280; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; width: 100%;">
                    Close
                </button>
            `;
            document.body.appendChild(modal);
        }

        function showUploadDialog(backendUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10001;
                max-width: 500px;
            `;
            modal.innerHTML = `
                <h3 style="margin-top: 0; color: #059669;">üì§ Upload Excel File</h3>
                <p style="line-height: 1.6; color: #374151;">
                    Select the updated Excel file to upload:
                </p>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" 
                       style="margin: 15px 0; padding: 10px; border: 2px dashed #d1d5db; border-radius: 6px; width: 100%;">
                <div id="uploadStatus" style="margin: 10px 0; padding: 10px; border-radius: 6px; display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="uploadExcelFile('${backendUrl}')" 
                            style="flex: 1; background: #059669; color: white; padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
                        Upload
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="flex: 1; background: #6b7280; color: white; padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function uploadExcelFile(backendUrl) {
            const fileInput = document.getElementById('excelFileInput');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.textContent = '‚ö†Ô∏è Please select a file first';
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('excel', file);
            
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#dbeafe';
            statusDiv.style.color = '#1e40af';
            statusDiv.textContent = '‚è≥ Uploading...';
            
            try {
                const response = await fetch(`${backendUrl}/api/excel/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.style.background = '#d1fae5';
                    statusDiv.style.color = '#065f46';
                    statusDiv.textContent = '‚úÖ File uploaded successfully! Refreshing dashboard...';
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.textContent = `‚ùå Upload failed: ${result.error}`;
                }
            } catch (error) {
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.textContent = `‚ùå Upload error: ${error.message}`;
            }
        }

        function showExcelInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 500px;
            `;
            modal.innerHTML = `
                <h2 style="margin-top: 0;">üìä Excel Workbook Opened</h2>
                <p><strong>Edit with Live Sync Enabled</strong></p>
                <ol style="text-align: left;">
                    <li>Edit any values in the Excel sheets</li>
                    <li>Formulas will auto-calculate</li>
                    <li>Save the file (Ctrl+S)</li>
                    <li>Changes sync automatically to dashboard</li>
                    <li>Refresh browser to see updates</li>
                </ol>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>üí° Auto-Sync Active</strong><br>
                    The Excel sync service watches for changes.<br>
                    Your edits will appear on the dashboard immediately after saving.
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="location.reload()" style="padding: 10px 20px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üîÑ Refresh Dashboard
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #ddd; border: none; border-radius: 5px; cursor: pointer;">
                        Continue Working
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize AI Chat Widget
        document.addEventListener('DOMContentLoaded', () => {
            new AIChatComponent('ai-chat-container', {
                project: 'Executive Dashboard'
            });
        });
    </script>
</body>

</html>