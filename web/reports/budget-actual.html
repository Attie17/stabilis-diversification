<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Budget vs Actual - Stabilis</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/ai-chat-component.css">
    <style>
        .report-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .report-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: white;
            color: #3b82f6;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .budget-table th,
        .budget-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        .budget-table th:first-child,
        .budget-table td:first-child {
            text-align: left;
        }

        .budget-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #1f2937;
        }

        .budget-table .over-budget {
            color: #ef4444;
            font-weight: 600;
        }

        .budget-table .under-budget {
            color: #10b981;
            font-weight: 600;
        }

        .report-section {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .budget-breakdown-btn {
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
        }

        .budget-breakdown-btn:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        .breakdown-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .breakdown-modal.active {
            display: flex;
        }

        .breakdown-card {
            background: white;
            width: min(520px, 92%);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.25);
            position: relative;
        }

        .breakdown-card h3 {
            margin-top: 0;
            margin-bottom: 0.35rem;
        }

        .breakdown-card ul {
            padding-left: 1.25rem;
            margin: 1rem 0;
        }

        .breakdown-card li {
            margin-bottom: 0.4rem;
        }

        .breakdown-close {
            position: absolute;
            top: 1rem;
            right: 1.25rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #475569;
        }
    </style>
</head>

<body>
    <div class="report-container">
        <div class="report-header">
            <h1> Budget vs Actual Report</h1>
            <p>Financial performance tracking and variance analysis</p>
            <button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
        </div>

        <div class="report-section">
            <h2>Investment Budget Tracking</h2>
            <table class="budget-table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Budget</th>
                        <th>Actual Spend</th>
                        <th>Remaining</th>
                        <th>Variance</th>
                    </tr>
                </thead>
                <tbody id="budget-table-body">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #666;">
                            Loading budget data from database...
                        </td>
                    </tr>
                </tbody>
            </table>
            <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">Note: Projects not yet commenced. Spending
                will be tracked monthly once implementation begins.</p>
        </div>

        <div style="text-align: center; margin-top: 3rem;">
            <a href="../executive-dashboard.html" class="back-btn">üìä Executive Command</a>
        </div>
    </div>
    <div class="breakdown-modal" id="budget-breakdown-modal" aria-hidden="true" role="dialog"
        aria-labelledby="budget-breakdown-title">
        <div class="breakdown-card">
            <button class="breakdown-close" type="button" id="budget-breakdown-close"
                aria-label="Close breakdown">‚úï</button>
            <h3 id="budget-breakdown-title">Budget Breakdown</h3>
            <p id="budget-breakdown-subtitle" style="color:#475569; margin-top:0;">Loading details‚Ä¶</p>
            <ul id="budget-breakdown-list"></ul>
            <p id="budget-breakdown-note" style="color:#475569; font-size:0.9rem;"></p>
        </div>
    </div>
    
    <!-- AI Chat Widget Container -->
    <div id="ai-chat-container"></div>
    
    <script src="../js/auth.js"></script>
    <script src="../js/report-access.js"></script>
    <script>
        let budgetBreakdowns = {};
        
        async function loadBudgetData() {
            try {
                const response = await fetch('/api/budget?period=combined');
                if (!response.ok) throw new Error('Failed to fetch budget data');
                
                const result = await response.json();
                const { data } = result;
                
                // Build table rows
                const tbody = document.getElementById('budget-table-body');
                let rowsHTML = '';
                let grandTotal = 0;
                
                data.expenditureByCategory.forEach(category => {
                    const amount = category.totalAmount;
                    grandTotal += amount;
                    const amountDisplay = amount >= 1000000 ? 
                        `R${(amount / 1000000).toFixed(2)}M` : 
                        `R${Math.round(amount / 1000).toLocaleString()}`;
                    
                    // Build breakdown for modal
                    budgetBreakdowns[category.category] = {
                        budget: {
                            total: amountDisplay,
                            items: category.breakdown.map(item => ({
                                label: `${item.originalCategory} (${item.period === 'Q1-2026' ? 'Q1 2026' : 'FY 2026-27'})`,
                                amount: item.amount >= 1000000 ? 
                                    `R${(item.amount / 1000000).toFixed(2)}M` : 
                                    `R${Math.round(item.amount / 1000).toLocaleString()}`
                            })),
                            note: `Based on Excel workbook budget allocation synced to database.`
                        },
                        actual: {
                            total: 'R0',
                            items: [{ label: 'Implementation not yet commenced', amount: 'Pending' }],
                            note: 'Spending will be tracked monthly once implementation begins.'
                        }
                    };
                    
                    rowsHTML += `
                        <tr>
                            <td>${category.category}</td>
                            <td><button class="budget-breakdown-btn" data-project="${category.category}" data-type="budget">${amountDisplay}</button></td>
                            <td><button class="budget-breakdown-btn" data-project="${category.category}" data-type="actual">R0</button></td>
                            <td>${amountDisplay}</td>
                            <td class="under-budget">0%</td>
                        </tr>
                    `;
                });
                
                const grandTotalDisplay = `R${(grandTotal / 1000000).toFixed(2)}M`;
                rowsHTML += `
                    <tr style="background: #f3f4f6; font-weight: 700;">
                        <td>TOTAL</td>
                        <td><button class="budget-breakdown-btn" data-project="Total" data-type="budget">${grandTotalDisplay}</button></td>
                        <td><button class="budget-breakdown-btn" data-project="Total" data-type="actual">R0</button></td>
                        <td>${grandTotalDisplay}</td>
                        <td class="under-budget">On Track</td>
                    </tr>
                `;
                
                // Add Total breakdown
                budgetBreakdowns['Total'] = {
                    budget: {
                        total: grandTotalDisplay,
                        items: data.expenditureByCategory.map(cat => ({
                            label: `${cat.category} allocation`,
                            amount: cat.totalAmount >= 1000000 ? 
                                `R${(cat.totalAmount / 1000000).toFixed(2)}M` : 
                                `R${Math.round(cat.totalAmount / 1000).toLocaleString()}`
                        })),
                        note: 'Sum of all programme allocations from Excel budget workbook.'
                    },
                    actual: {
                        total: 'R0',
                        items: [{ label: 'No cash released yet across any stream', amount: 'Pending' }],
                        note: 'Finance team will start monthly tracking once first PO is issued.'
                    }
                };
                
                tbody.innerHTML = rowsHTML;
                attachBudgetBreakdownHandlers();
                
                console.log('‚úÖ Budget tracking loaded from database');
            } catch (error) {
                console.error('‚ùå Failed to load budget data:', error);
                document.getElementById('budget-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: #dc2626;">
                            <strong>‚ö†Ô∏è Error loading budget data</strong><br>${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize auth first
            if (typeof initAuth === 'function') {
                initAuth();
            }
            
            // Load budget data
            loadBudgetData();
            
            // Then initialize report page
            if (typeof initReportPage === 'function') {
                initReportPage({
                    reportKey: 'budget-actual',
                    reportTitle: 'Budget vs Actual Report'
                });
            }
        });

        function attachBudgetBreakdownHandlers() {
            document.querySelectorAll('.budget-breakdown-btn').forEach(btn => {
                btn.addEventListener('click', () => showBudgetBreakdown(btn.dataset.project, btn.dataset.type));
            });
            document.getElementById('budget-breakdown-close')?.addEventListener('click', closeBudgetBreakdown);
            document.getElementById('budget-breakdown-modal')?.addEventListener('click', (event) => {
                if (event.target.id === 'budget-breakdown-modal') closeBudgetBreakdown();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') closeBudgetBreakdown();
            });
        }

        function showBudgetBreakdown(project, type) {
            const modal = document.getElementById('budget-breakdown-modal');
            const title = document.getElementById('budget-breakdown-title');
            const subtitle = document.getElementById('budget-breakdown-subtitle');
            const list = document.getElementById('budget-breakdown-list');
            const note = document.getElementById('budget-breakdown-note');
            const projectData = budgetBreakdowns[project] || {};
            const breakdown = projectData[type] || null;

            const label = type === 'budget' ? 'Budget' : 'Actual Spend';
            title.textContent = `${project} ‚Äî ${label}`;

            if (!breakdown) {
                subtitle.textContent = 'No supporting data recorded yet.';
                list.innerHTML = '';
                note.textContent = '';
            } else {
                subtitle.textContent = `Total: ${breakdown.total}`;
                list.innerHTML = breakdown.items.map(item => `
                    <li>
                        <strong>${item.label}</strong><br>
                        <span style="color:#2563eb">${item.amount}</span>
                    </li>
                `).join('');
                note.textContent = breakdown.note || '';
            }

            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeBudgetBreakdown() {
            const modal = document.getElementById('budget-breakdown-modal');
            if (!modal) return;
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }
    </script>
    <script src="../js/ai-chat-component.js"></script>
    <script>
        // Initialize AI Chat Widget
        document.addEventListener('DOMContentLoaded', () => {
            new AIChatComponent('ai-chat-container', {
                project: 'Budget vs Actual Report'
            });
        });
    </script>
</body>

</html>